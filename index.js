(function(){"use strict";function c(e,t,i,o,s,n,a,l){var r=typeof e=="function"?e.options:e;return t&&(r.render=t,r.staticRenderFns=i,r._compiled=!0),{exports:e,options:r}}const u={extends:"k-field",props:{value:String,emptyText:{type:String,default:"Add Apple Music embed..."},format:{type:String,default:"embed"}},computed:{hasContent(){return this.value&&this.value.trim()!==""},previewHtml(){if(!this.value)return"";if(this.format==="embed")return this.value;if(this.format==="link"){const e=this.transformLinkToEmbedSrc(this.value);return e?`<iframe allow="autoplay *; encrypted-media *;" frameborder="0" height="150" style="width:100%;overflow:hidden;background:transparent;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="${e}"></iframe>`:""}return""}},methods:{transformLinkToEmbedSrc(e){return!e||typeof e!="string"||!e.startsWith("https://music.apple.com")?"":e.replace(/^https:\/\/music\.apple\.com/,"https://embed.music.apple.com")},handleSubmit(e){const t=e[this.name];if(!(this.format==="embed"?typeof t=="string"&&t.includes("<iframe")&&t.includes("embed.music.apple.com"):this.format==="link"?typeof t=="string"&&t.startsWith("https://music.apple.com/"):!1)){this.$panel.notification.error({message:this.format==="link"?"Enter a valid link (e.g. https://music.apple.com/...)":"Valid Apple Music embed not found.",timeout:4e3});return}Promise.resolve().then(()=>{this.$emit("input",t),this.$emit("change",t),this.closeDrawer(),this.$panel.notification.success({message:"Ok",timeout:4e3})}).catch(()=>{this.$panel.notification.error({message:"An error occurred",timeout:4e3})})},openDrawer(){const e={label:this.format==="link"?"Apple Music URL":"Embed Code",type:this.format==="link"?"url":"textarea",icon:this.icon==="link"?"link":"code",spellcheck:!1,autofocus:!0,help:this.help||(this.format==="link"?"Paste an Apple Music URL like https://music.apple.com...":"Paste the embed code (iframe) for a album, song, or playlist from Apple Music.")};this.format!=="link"&&(e.font="monospace",e.buttons=!1,e.size="medium",e.validate=t=>typeof t=="string"&&t.includes("<iframe")&&t.includes("embed.music.apple.com")||"Please paste valid Apple Music embed code."),this.$panel.drawer.open({component:"k-form-drawer",props:{icon:"album",title:this.label||"Apple Music Embed",value:{[this.name]:this.value},fields:{[this.name]:e}},on:{submit:this.handleSubmit.bind(this)}})},closeDrawer(){this.$panel.drawer.close()}}};var d=function(){var t=this,i=t._self._c;return i("k-field",t._b({staticClass:"k-applemusic-field"},"k-field",t.$props,!1),[i("k-button",{attrs:{slot:"options",icon:"edit-line",size:"xs",variant:"filled"},on:{click:t.openDrawer},slot:"options"},[t._v("Edit...")]),t.hasContent?t._e():i("div",{staticClass:"k-applemusic-empty"},[i("k-grid",{staticStyle:{"--columns":"1",gap:"0.5rem"}},[i("k-empty",{attrs:{text:t.emptyText,icon:"album"},on:{click:t.openDrawer}})],1)],1),i("div",{staticClass:"k-applemusic-preview",domProps:{innerHTML:t._s(t.previewHtml)}})],1)},p=[],h=c(u,d,p);const f=h.exports,m={created(){var e;console.log("[AppleMusicBlock] format:",this.format),console.log("[AppleMusicBlock] value:",(e=this.content)==null?void 0:e.apple_music)},computed:{hasContent(){var e,t;return((t=(e=this.content)==null?void 0:e.apple_music)==null?void 0:t.length)>0},format(){var t;const e=(t=this.content)==null?void 0:t.format;return typeof e=="string"?e:e===!0?"link":"embed"},hasErrors(){var t;const e=((t=this.content)==null?void 0:t.apple_music)||"";return e?this.format==="embed"?!e.includes("<iframe"):this.format==="link"?!/^https:\/\/music\.apple\.com\/.+/.test(e):!0:!1},previewHtml(){var t;const e=((t=this.content)==null?void 0:t.apple_music)||"";return e?this.format==="embed"?e:this.format==="link"?`<iframe 
					allow="autoplay *; encrypted-media *;" 
					frameborder="0" 
					height="150" 
					style="width:100%;overflow:hidden;background:transparent;" 
					sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" 
					src="${e.replace(/^https:\/\/music\.apple\.com/,"https://embed.music.apple.com")}"></iframe>`:"":""}}};var w=function(){var t=this,i=t._self._c;return i("div",{staticClass:"k-applemusic-preview"},[t.hasContent&&!t.hasErrors?[i("k-html-field-preview",{attrs:{value:t.previewHtml}})]:t.hasErrors?[i("k-grid",{staticStyle:{"--columns":"1",gap:"0.5rem"}},[i("k-box",{attrs:{theme:"warning",icon:"alert",text:`Invalid Apple Music ${t.format==="embed"?"embed":"link"}`}})],1)]:[i("k-empty",{attrs:{icon:"album",text:"Add an Apple Music embed..."}})]],2)},g=[],v=c(m,w,g);const b=v.exports,k={name:"Apple Music",props:{appName:String,appBuild:String,hasToken:Boolean,storefront:String,songsLimit:{type:Number,default:15}},data(){return{busy:!1,msg:this.hasToken?"Token saved.":"Not connected yet.",items:[],loading:!1,error:null,limit:this.songsLimit,offset:0,language:"en-US",storefrontInfo:null}},created(){this.hasToken&&(this.fetchStorefront(),this.fetchRecent())},watch:{hasToken(e){e?(this.fetchStorefront(),this.fetchRecent()):(this.items=[],this.error=null,this.loading=!1,this.storefrontInfo=null)}},computed:{headerTitle(){return this.hasToken?"Apple Music":"Authorize Apple Music"},collectionItems(){return(this.items||[]).map(e=>{const t=this.trackUrl(e),i={id:e.id,text:this.trackTitle(e),info:this.artistName(e),image:{src:this.artworkUrl(e,300)||void 0,ratio:"1/1",cover:!0,back:"pattern"},link:t,icon:"music",target:"_blank",title:this.trackSubtitle(e)};return t&&(i.options=[{icon:"headphones",text:"Listen",click:()=>{t&&window.open(t,"_blank")}},"-",{icon:"url",text:"Copy Link",click:()=>this.copyToClipboard(t,"Link copied to clipboard")},{icon:"code",text:"Embed Code",click:()=>{const o=this.buildEmbedCode(t);if(!o){this.notify("error","Could not create embed code for this link");return}this.copyToClipboard(o,"Embed copied to clipboard")}}]),i})},statReports(){const e=[{label:"Version "+this.appBuild,value:this.appName,icon:"layers",info:"Build Info",theme:"info"}];return this.storefrontInfo&&e.push({label:"Storefront",value:this.storefrontInfo.id,icon:"store",info:this.storefrontInfo.language,theme:this.storefrontInfo.id?"positive":"warning"}),e}},mounted(){(async()=>{try{await this.loadMusicKit(this.cspNonce);const e=await fetch("/applemusic/dev-token",{credentials:"same-origin"});if(!e.ok)throw new Error("dev-token "+e.status);const{token:t}=await e.json(),i=(this.storefront||"auto").toLowerCase(),o={developerToken:t,app:{name:this.appName||"KirbyMusicKit",build:this.appBuild||"2.0.0"}};i!=="auto"&&(o.storefrontId=i),window.MusicKit.configure(o)}catch{this.notify("error","Failed to prepare Apple Music (CSP/network/dev token)")}})(),(async()=>{try{const e=await fetch("/applemusic/has-token",{credentials:"same-origin"});if(e.ok){const{hasToken:t}=await e.json();this.hasToken=!!t}}catch(e){console.warn("has-token check failed:",e)}})();try{const e=new URL(window.location.href);e.searchParams.get("connected")==="1"&&(this.notify("success","Connected — token saved."),e.searchParams.delete("connected"),window.history.replaceState({},"",e.toString()))}catch{}},methods:{async copyToClipboard(e,t="Copied"){var i;try{if(!e)throw new Error("Nothing to copy");if((i=navigator.clipboard)!=null&&i.writeText)await navigator.clipboard.writeText(e);else{const o=document.createElement("textarea");o.value=e,o.setAttribute("readonly",""),o.style.position="fixed",o.style.opacity="0",document.body.appendChild(o),o.select(),document.execCommand("copy"),document.body.removeChild(o)}this.notify("success",t)}catch(o){console.warn("copyToClipboard failed:",o),this.notify("error","Could not copy to clipboard")}},toEmbedUrl(e){var t;try{const i=new URL(e);if(!/apple\.com$/i.test(i.hostname))return null;i.hostname="embed.music.apple.com";const o=i.pathname.split("/").filter(Boolean);if(!(o.length>0&&/^[a-z]{2}$/i.test(o[0]))){const n=(((t=this.storefrontInfo)==null?void 0:t.id)||this.storefront||"us").toString().toLowerCase();o.unshift(n),i.pathname="/"+o.join("/")}return i.toString()}catch{return null}},buildEmbedCode(e){const t=this.toEmbedUrl(e);return t?`<iframe allow="autoplay *; encrypted-media *;" frameborder="0" height="150" style="width:100%;overflow:hidden;background:transparent;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="${t}"></iframe>`:null},async loadMusicKit(e){var t,i;(t=window.MusicKit)!=null&&t.getInstance||(document.querySelector("script[data-am-mk]")?(i=window.MusicKit)!=null&&i.getInstance||await new Promise(o=>{window.addEventListener("musickitloaded",o,{once:!0}),setTimeout(o,50)}):await new Promise((o,s)=>{const n=document.createElement("script");n.src="https://js-cdn.music.apple.com/musickit/v3/musickit.js",n.async=!0,n.dataset.amMk="1",e&&n.setAttribute("nonce",e),n.onerror=s,document.head.appendChild(n);let a=!1,l=!1;const r=()=>{a&&l&&o()};n.onload=()=>{a=!0,r()},window.addEventListener("musickitloaded",()=>{l=!0,r()},{once:!0})}))},async redirectAuth(){try{this.busy=!0,this.notify("info","Redirecting to Apple Music sign-in…");const e=(this.storefront||"auto").toLowerCase(),t=window.location.href,i=`/applemusic/auth?sf=${encodeURIComponent(e)}&returnTo=${encodeURIComponent(t)}`;window.location.assign(i)}catch{this.notify("error","Could not start sign-in")}},async popupAuth(){try{this.busy=!0,this.notify("info","Opening Apple Music…");const e=(this.storefront||"").toLowerCase(),t=e?`/applemusic/auth?sf=${encodeURIComponent(e)}`:"/musickit/auth",i=window.open(t,"amPopup","width=480,height=600"),o=async s=>{if(s.origin!==window.location.origin)return;const n=s.data||{};if(n.type==="musickit-token"){window.removeEventListener("message",o),n.ok?(this.notify("success","Connected — token saved"),this.hasToken=!0):(console.error("Popup failed:",n.error,n.detail||""),this.notify("warning","Authorization cancelled or failed"));try{i&&i.close()}catch{}this.busy=!1}};window.addEventListener("message",o),setTimeout(()=>{try{(!i||i.closed)&&(window.removeEventListener("message",o),this.busy=!1,this.notify("info","Popup closed"))}catch{}},6e4)}catch(e){console.error("popupAuth error:",e),this.notify("error","Could not open popup"),this.busy=!1}},async refreshDevToken(){var e,t;try{const i=await fetch("/applemusic/dev-token/refresh",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json"}});if(!i.ok){const a=await i.text();throw new Error(`HTTP ${i.status}: ${a.slice(0,200)}`)}const{token:o}=await i.json();if(!o)throw new Error("No token returned");const s=(this.storefront||"auto").toLowerCase(),n={developerToken:o,app:{name:this.appName||"KirbyMusicKit",build:this.appBuild||"dev"}};if(s&&s!=="auto"&&(n.storefrontId=s),!window.MusicKit)throw new Error("MusicKit SDK not loaded");window.MusicKit.configure(n);try{window.MusicKit.getInstance()}catch{}this.notify("success","Developer token refreshed"),this.hasToken&&((e=this.fetchStorefront)==null||e.call(this),(t=this.fetchRecent)==null||t.call(this))}catch(i){console.error("refreshDevToken failed:",i),this.notify("error",`Could not refresh dev token: ${i.message||i}`)}},async disconnect(){var e,t;try{if(!confirm("Disconnect Apple Music for this Panel user?"))return;this.busy=!0,this.notify("info","Disconnecting...");try{await this.loadMusicKit(this.cspNonce);const o=(t=(e=window.MusicKit)==null?void 0:e.getInstance)==null?void 0:t.call(e);o!=null&&o.isAuthorized&&await o.unauthorize()}catch(o){console.warn("unauthorize() skipped/failed:",o)}const i=await fetch("/applemusic/delete-user-token",{method:"POST",credentials:"same-origin"});if(!i.ok)throw new Error("delete-token "+i.status);this.hasToken=!1,this.notify("success","Disconnected — saved token removed")}catch(i){console.error("disconnect() error:",i),this.notify("error","Could not disconnect — see console for details")}finally{this.busy=!1}},async fetchStorefront(){var e,t;try{const i=new URLSearchParams({language:this.language}).toString(),o=await fetch(`/applemusic/storefront?${i}`,{credentials:"same-origin"});if(!o.ok)throw new Error("storefront "+o.status);const s=await o.json(),n=((e=s==null?void 0:s.data)==null?void 0:e[0])||{};this.storefrontInfo={id:n.id||null,language:((t=n.attributes)==null?void 0:t.defaultLanguageTag)||null}}catch{this.storefrontInfo=null,this.notify("info","Could not load storefront")}},async fetchRecent(e={}){this.loading=!0,this.error=null;const t={limit:e.limit??this.limit,offset:e.offset??this.offset,language:this.language};try{const i=new URLSearchParams({limit:String(t.limit),offset:String(t.offset),language:t.language}).toString(),s=await(await fetch(`/applemusic/recent?${i}`,{credentials:"same-origin"})).json();this.items=Array.isArray(s==null?void 0:s.data)?s.data:[],this.limit=t.limit,this.offset=t.offset}catch(i){this.error=(i==null?void 0:i.message)||"Failed to load recently played tracks"}finally{this.loading=!1}},nextPage(){this.fetchRecent({offset:this.offset+this.limit})},prevPage(){this.fetchRecent({offset:Math.max(0,this.offset-this.limit)})},artworkUrl(e,t=100){var o;const i=(o=e==null?void 0:e.attributes)==null?void 0:o.artwork;return i!=null&&i.url?i.url.replace("{w}",t).replace("{h}",t):null},trackTitle(e){var t;return((t=e==null?void 0:e.attributes)==null?void 0:t.name)||"Untitled"},trackSubtitle(e){var o,s;const t=(o=e==null?void 0:e.attributes)==null?void 0:o.artistName,i=(s=e==null?void 0:e.attributes)==null?void 0:s.albumName;return[t,i].filter(Boolean).join(" — ")},artistName(e){var t;return(t=e==null?void 0:e.attributes)==null?void 0:t.artistName},albumName(e){var t;return((t=e==null?void 0:e.attributes)==null?void 0:t.albumName)||"Untitled"},trackUrl(e){var t;return((t=e==null?void 0:e.attributes)==null?void 0:t.url)||null},notify(e,t){var o;const i=this.$panel||((o=this.$root)==null?void 0:o.$panel);if(i!=null&&i.notification){if(typeof i.notification[e]=="function"){i.notification[e](t);return}if(typeof i.notification.create=="function"){i.notification.create({message:t,type:e});return}}console[e==="error"?"error":"log"](`[${e}] ${t}`)}}};var y=function(){var t=this,i=t._self._c;return i("k-panel-inside",[i("k-view",{staticClass:"k-musickit-auth"},[i("k-header",{staticClass:"k-site-view-header"},[t._v(" "+t._s(t.headerTitle)+" "),i("k-button-group",{attrs:{slot:"buttons"},slot:"buttons"},[t.hasToken?t._e():i("k-button",{attrs:{disabled:t.busy,variant:"filled",theme:"green-icon",icon:"open",size:"xs"},on:{click:t.redirectAuth}},[t._v(" "+t._s(t.hasToken?"Re-authorize Apple Music":"Authorize Apple Music")+" ")]),t.hasToken?i("k-button",{attrs:{disabled:t.busy,variant:"filled",icon:"reset-token",text:"Reset Token",size:"xs",title:"Reset the Cached Token"},on:{click:t.refreshDevToken}}):t._e(),t.hasToken?i("k-button",{attrs:{disabled:t.busy,variant:"filled",theme:"red-icon",icon:"logout",text:"Disconnect",size:"xs",title:"Delete the Saved Token"},on:{click:t.disconnect}}):t._e()],1)],1),t.hasToken?t._e():i("k-box",{staticStyle:{"margin-bottom":".5rem"},attrs:{theme:"info",icon:"info"}},[t._v(" Connect your Apple Music account to see recently played tracks and more. ")]),i("k-section",[i("k-stats",{staticClass:"k-musickit-info-reports",attrs:{reports:t.statReports,size:"small"}})],1),t.hasToken?[i("k-section",{attrs:{label:"Recently Played Tracks"}},[i("k-button",{attrs:{slot:"options",size:"xs",variant:"filled",icon:"refresh"},on:{click:function(o){return t.fetchRecent()}},slot:"options"}),t.error?i("k-box",{attrs:{theme:"negative"}},[t._v(t._s(t.error))]):t.loading?i("k-box",{attrs:{icon:"loader"}},[t._v("Loading…")]):i("div",[i("k-collection",{attrs:{items:t.collectionItems,layout:"cards",size:"large"}}),t.items.length===0?i("div",[t._v(" No items returned. ")]):t._e()],1),i("k-box",{staticStyle:{"margin-top":"1rem"},attrs:{theme:"none"}},[i("k-button-group",{attrs:{responsive:"true",theme:"gray-icon"}},[i("k-button",{attrs:{variant:"filled",size:"xs",title:"Previous Page",icon:"angle-left",disabled:t.offset<=0},on:{click:t.prevPage}}),i("k-button",{attrs:{variant:"filled",size:"xs",title:"Next Page",icon:"angle-right",disabled:t.items.length<t.limit},on:{click:t.nextPage}})],1)],1)],1)]:t._e()],2)],1)},C=[],_=c(k,y,C);const M=_.exports,T={album:'<svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.5,5.5v9.5c0,1.38-1.12,2.5-2.5,2.5s-2.5-1.12-2.5-2.5,1.12-2.5,2.5-2.5c.17,0,.34.02.5.05v-4.65l-6,.6v7.5c0,1.38-1.12,2.5-2.5,2.5s-2.5-1.12-2.5-2.5,1.12-2.5,2.5-2.5c.17,0,.34.02.5.05v-7.05l10-1Z"/><path d="M23,20V4c0-1.66-1.34-3-3-3H4c-1.66,0-3,1.34-3,3v16c0,1.66,1.34,3,3,3h16c1.66,0,3-1.34,3-3ZM4,21c-.55,0-1-.45-1-1V4c0-.55.45-1,1-1h16c.55,0,1,.45,1,1v16c0,.55-.45,1-1,1H4Z"/></svg>',"album-filled":'<svg id="a" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.5,5.5v9.5c0,1.38-1.12,2.5-2.5,2.5s-2.5-1.12-2.5-2.5,1.12-2.5,2.5-2.5c.17,0,.34.02.5.05v-4.65l-6,.6v7.5c0,1.38-1.12,2.5-2.5,2.5s-2.5-1.12-2.5-2.5,1.12-2.5,2.5-2.5c.17,0,.34.02.5.05v-7.05l10-1ZM23,20V4c0-1.66-1.34-3-3-3H4c-1.66,0-3,1.34-3,3v16c0,1.66,1.34,3,3,3h16c1.66,0,3-1.34,3-3Z"/></svg>',"edit-line":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 18.89H6.41421L15.7279 9.57627L14.3137 8.16206L5 17.4758V18.89ZM21 20.89H3V16.6473L16.435 3.21231C16.8256 2.82179 17.4587 2.82179 17.8492 3.21231L20.6777 6.04074C21.0682 6.43126 21.0682 7.06443 20.6777 7.45495L9.24264 18.89H21V20.89ZM15.7279 6.74785L17.1421 8.16206L18.5563 6.74785L17.1421 5.33363L15.7279 6.74785Z"></path></svg>',headphones:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 12H7C8.10457 12 9 12.8954 9 14V19C9 20.1046 8.10457 21 7 21H4C2.89543 21 2 20.1046 2 19V12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12V19C22 20.1046 21.1046 21 20 21H17C15.8954 21 15 20.1046 15 19V14C15 12.8954 15.8954 12 17 12H20C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12Z"></path></svg>',music:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3V17C20 19.2091 18.2091 21 16 21C13.7909 21 12 19.2091 12 17C12 14.7909 13.7909 13 16 13C16.7286 13 17.4117 13.1948 18 13.5351V6H9V17C9 19.2091 7.20914 21 5 21C2.79086 21 1 19.2091 1 17C1 14.7909 2.79086 13 5 13C5.72857 13 6.41165 13.1948 7 13.5351V3H20Z"></path></svg>',"reset-token":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 12.5 6.5 15 9 17.5 11.5 15 9 12.5ZM15 2.5C11.5724 2.5 8.76444 5.15304 8.51763 8.51763 5.15304 8.76445 2.5 11.5724 2.5 15 2.5 18.5899 5.41015 21.5 9 21.5 12.4276 21.5 15.2356 18.847 15.4824 15.4824 18.847 15.2356 21.5 12.4276 21.5 9 21.5 5.41015 18.5899 2.5 15 2.5ZM15.3234 13.4886C14.7575 11.1126 12.8874 9.24245 10.5114 8.67665 10.6772 6.34229 12.6234 4.5 15 4.5 17.4853 4.5 19.5 6.51472 19.5 9 19.5 11.3766 17.6577 13.3228 15.3234 13.4886ZM13.5 15C13.5 17.4853 11.4853 19.5 9 19.5 6.51472 19.5 4.5 17.4853 4.5 15 4.5 12.5147 6.51472 10.5 9 10.5 11.4853 10.5 13.5 12.5147 13.5 15ZM3 7C3 4.79086 4.79086 3 7 3H8.5V5H7C5.89543 5 5 5.89543 5 7V8.5H3V7ZM19 17V15.5H21V17C21 19.2091 19.2091 21 17 21H15.5V19H17C18.1046 19 19 18.1046 19 17Z"></path></svg>'};panel.plugin("scottboms/kirby-applemusic",{icons:T,components:{"k-musickit-view":M},fields:{applemusic:f},blocks:{applemusic:b}})})();
